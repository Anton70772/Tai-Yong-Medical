import e from"node:path";import n from"node:process";import*as i from"@clack/prompts";import{intro as t,outro as o}from"@clack/prompts";import{WriteStream as l}from"node:tty";import{PostHog as r}from"posthog-node";import{webcrypto as a}from"node:crypto";import{Axiom as s}from"@axiomhq/js";import c from"node:fs/promises";import*as p from"node:fs";import f from"node:fs";import{detect as d,parseNi as u}from"@antfu/ni";import{exec as m}from"node:child_process";import g from"node:util";import*as b from"diff";import{transformAsync as y}from"@babel/core";import*as w from"@babel/types";var h,v={reset:[0,0],bold:[1,22],dim:[2,22],italic:[3,23],underline:[4,24],overline:[53,55],inverse:[7,27],hidden:[8,28],strikethrough:[9,29],black:[30,39],red:[31,39],green:[32,39],yellow:[33,39],blue:[34,39],magenta:[35,39],cyan:[36,39],white:[37,39],gray:[90,39],bgBlack:[40,49],bgRed:[41,49],bgGreen:[42,49],bgYellow:[43,49],bgBlue:[44,49],bgMagenta:[45,49],bgCyan:[46,49],bgWhite:[47,49],bgGray:[100,49],redBright:[91,39],greenBright:[92,39],yellowBright:[93,39],blueBright:[94,39],magentaBright:[95,39],cyanBright:[96,39],whiteBright:[97,39],bgRedBright:[101,49],bgGreenBright:[102,49],bgYellowBright:[103,49],bgBlueBright:[104,49],bgMagentaBright:[105,49],bgCyanBright:[106,49],bgWhiteBright:[107,49],blackStylize:["#121212","#eeeeee18"],redStylize:["#cb7676","#ab5959"],greenStylize:["#4d9375","#1e754f"],yellowStylize:["#f6c177","#f6c17790"],blueStylize:["#6394bf","#296aa3"],magentaStylize:["#c391e6","#c391e690"],pinkStylize:["#ed9cc2","#ed9cc290"],cyanStylize:["#5eaab5","#2993a3"],whiteStylize:["#ffffff","#ffffff9f"],grayStylize:["#888888","#444444"]},x=l.prototype.hasColors(),k=(e,n)=>{if(!x)return e=>e;const i=`[${e}m`,t=`[${n}m`;return e=>{const n=`${e}`;let o=n.indexOf(t);if(-1===o)return i+n+t;let l=i,r=0;for(;-1!==o;)l+=n.slice(r,o)+i,r=o+t.length,o=n.indexOf(t,r);return l+=n.slice(r)+t,l}},C=(h=(e,n,i)=>k(`38;2;${e};${n};${i}`,39),e=>{const[n,i,t]=(e=>{let[,n]=/([\da-f]{3,6})/i.exec(e)||[];const i=n?n.length:0;if(3===i)n=n[0]+n[0]+n[1]+n[1]+n[2]+n[2];else if(6!==i)return[0,0,0];const t=Number.parseInt(n,16);return[t>>16&255,t>>8&255,255&t]})(e);return h(n,i,t)}),j=k(...v.bold),L=k(...v.dim);C(v.blackStylize[0]),C(v.blackStylize[1]);var F=C(v.redStylize[0]);C(v.redStylize[1]);var M=C(v.greenStylize[0]);C(v.greenStylize[1]);var S=C(v.yellowStylize[0]);C(v.yellowStylize[1]),C(v.blueStylize[0]),C(v.blueStylize[1]);var P=C(v.magentaStylize[0]);C(v.magentaStylize[1]);var $=C(v.pinkStylize[0]);C(v.pinkStylize[1]);var N=C(v.cyanStylize[0]);C(v.cyanStylize[1]),C(v.whiteStylize[0]);var z=C(v.whiteStylize[1]),I=C(v.grayStylize[0]);C(v.grayStylize[1]);var E,A,T="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict",V=128;function O(e=21){var n;n=e-=0,!E||E.length<n?(E=Buffer.allocUnsafe(n*V),a.getRandomValues(E),A=0):A+n>E.length&&(a.getRandomValues(E),A=0);let i="";for(let t=(A+=n)-e;t<A;t++)i+=T[63&E[t]];return i}var R=new s({token:"xaat-137e6732-9a45-48d9-b12c-964c9fa88ed3"}),B=async(e,...n)=>{R.ingest("install",{level:e,env:{name:process.env.MILLION_INSTALL_NAME,version:process.env.MILLION_INSTALL_VERSION,root:process.env.MILLION_INSTALL_ROOT},message:JSON.stringify(n)}),await R.flush()},D=R.flush,_=new r("phc_dnFdhVY0JlEpyRhxewVBWgV7StMjHPFG7NbTPG26TNN",{host:"https://app.posthog.com",flushAt:1,flushInterval:0});function q({type:e="error",distinctId:n=`r-${O(10)}`,event:t,message:o,properties:l={},needAbort:r}){if(r)return function({title:e,message:n,properties:t={},status:o,distinctId:l=`r-${O(10)}`}){B("error",{distinctId:l,title:e,message:n,...t}),n&&i.log.error(n);i.log.error(`${F("Setup failed.")} Continue via ${N("http://million.dev/docs#manual-installation")}`),i.log.message(),_.capture({distinctId:l,event:"wizard-abort",properties:{body:{title:e,message:n,...t}}}),J().then((()=>process.exit(o??1)))}({title:t,message:o});o?("error"===e?i.log.error(o):i.note(o,t),B(e,{distinctId:n,event:t,message:o,...l})):B(e,{distinctId:n,event:t,...l}),_.capture({distinctId:n,event:t,properties:l})}var J=async()=>{try{return await D(),_.shutdownAsync()}catch{process.exit(1)}};async function W(e,n){const t=await e;if(!i.isCancel(t))return e;q({event:"wizard-cancel",properties:{body:t}}),n&&await n(),i.cancel("Million Lint setup cancelled."),await J(),process.exit(1)}async function U(n){const i=await async function(n){let i;try{i=await c.readFile(e.join(n,"package.json"),"utf8")}catch{return void q({event:"wizard-package-json-not-found",message:"Could not find package.json. Make sure to run the wizard in the root of your app!"})}return i}(n);if(!i)return;let t;try{t=JSON.parse(i)}catch{return q({event:"wizard-package-json-parse-error",message:"Unable to parse your package.json. Make sure it has a valid format!",needAbort:!0})}return{packageJson:t,packageJsonContents:i}}var H={name:"yarn",label:"yarn",lockFile:"yarn.lock",installCommand:"yarn add",dlxCommand:"npx"},G={name:"pnpm",label:"pnpm",lockFile:"pnpm-lock.yaml",installCommand:"pnpm install",dlxCommand:"pnpx"},Y={name:"npm",label:"npm",lockFile:"package-lock.json",installCommand:"npm install",dlxCommand:"npx"},Z={name:"bun",label:"bun",lockFile:"bun.lockb",installCommand:"bun add",dlxCommand:"bunx"},K=[G,H,Z,Y],Q={name:"craco",label:"Create React App",bundler:"webpack",prefix:"MillionLint.craco",configFilePath:"craco.config.js",possibleFileNames:["craco.config.js","craco.config.mjs","craco.config.cjs","craco.config.ts"],million:{configFileContent:"const million = require('million/compiler');\nmodule.exports = {\n  webpack: {\n    plugins: { add: [million.webpack({ auto: true })] }\n  }\n};"},millionLint:{configFileContent:"const MillionLint = require('@million/lint').default;\nmodule.exports = {\n  webpack: {\n    plugins: { add: [MillionLint.webpack({ legacyHmr: true })] }\n  }\n};"},millionAndMillionLint:{configFileContent:"const million = require('million/compiler');\nconst MillionLint = require('@million/lint').default;\nmodule.exports = {\n  webpack: {\n    plugins: {\n      add: [\n        million.webpack({ auto: true }),\n        MillionLint.webpack({ legacyHmr: true }),\n      ]\n    }\n  }\n};"}},X=[{name:"next",label:"Next.js",bundler:"next",prefix:"MillionLint.next",configFilePath:"next.config.mjs",possibleFileNames:["next.config.js","next.config.mjs"],million:{configFileContent:"import million from 'million/compiler';\n\n/** @type {import('next').NextConfig} */\nconst nextConfig = {\n  reactStrictMode: true,\n};\n\nconst millionConfig = {\n  auto: true,\n};\n\nexport default million.next(nextConfig, millionConfig);",configFileContentRSC:"import million from 'million/compiler';\n    \n/** @type {import('next').NextConfig} */\nconst nextConfig = {\n  reactStrictMode: true,\n};\n\nconst millionConfig = {\n  auto: { rsc: true },\n};\n\nexport default million.next(nextConfig, millionConfig);"},millionLint:{configFileContent:"import MillionLint from '@million/lint';\n\n/** @type {import('next').NextConfig} */\nconst nextConfig = {\n  reactStrictMode: true,\n};\n\nexport default MillionLint.next()(nextConfig);",configFileContentRSC:"import MillionLint from '@million/lint';\n\n/** @type {import('next').NextConfig} */\nconst nextConfig = {\n  reactStrictMode: true,\n};\n\nexport default MillionLint.next({ rsc: true })(nextConfig);"},millionAndMillionLint:{configFileContent:"import MillionLint from '@million/lint';\nimport million from 'million/compiler';\n\n/** @type {import('next').NextConfig} */\nconst nextConfig = {\n  reactStrictMode: true,\n};\n\nconst millionConfig = {\n  auto: true,\n};\n\nexport default million.next(MillionLint.next({ rsc: true })(nextConfig), millionConfig);",configFileContentRSC:"import MillionLint from '@million/lint';\nimport million from 'million/compiler';\n\n/** @type {import('next').NextConfig} */\nconst nextConfig = {\n  reactStrictMode: true,\n};\n\nconst millionConfig = {\n  auto: true,\n};\n\nexport default million.next(MillionLint.next({ rsc: true })(nextConfig), millionConfig);"}},{name:"astro",label:"Astro",bundler:"vite",prefix:"MillionLint.vite",configFilePath:"astro.config.mjs",possibleFileNames:["astro.config.js","astro.config.mjs","astro.config.cjs","astro.config.ts"],million:{configFileContent:"import { defineConfig } from 'astro/config';\nimport million from 'million/compiler';\n\nexport default defineConfig({\n  vite: {\n    plugins: [million.vite({ mode: 'react', server: true, auto: true })]\n  }\n});"},millionLint:{configFileContent:"import { defineConfig } from 'astro/config';\nimport MillionLint from '@million/lint';\n\nexport default defineConfig({\n  vite: {\n    plugins: [MillionLint.vite()]\n  }\n});"},millionAndMillionLint:{configFileContent:"import { defineConfig } from 'astro/config';\nimport million from 'million/compiler';\nimport MillionLint from '@million/lint';\n\nexport default defineConfig({\n  vite: {\n    plugins: [\n      million.vite({ mode: 'react', server: true, auto: true }),\n      MillionLint.vite(),\n    ]\n  }\n});"}},{name:"gatsby",label:"Gatsby",bundler:"webpack",prefix:"MillionLint.webpack",configFilePath:"gatsby-node.js",possibleFileNames:["gatsby-node.js","gatsby-node.ts"],otherPossibleFileNames:["gatsby-config.js","gatsby-config.ts"],million:{configFileContent:"const million = require('million/compiler');\n\nexports.onCreateWebpackConfig = ({ actions }) => {\n  actions.setWebpackConfig({\n    plugins: [million.webpack({ mode: 'react', server: true, auto: true })],\n  })\n};"},millionLint:{configFileContent:"const MillionLint = require('@million/lint').default;\n  \nexports.onCreateWebpackConfig = ({ actions }) => {\n  actions.setWebpackConfig({\n    plugins: [MillionLint.webpack()],\n  })\n};"},millionAndMillionLint:{configFileContent:"const million = require('million/compiler');\nconst MillionLint = require('@million/lint').default;\n\nexports.onCreateWebpackConfig = ({ actions }) => {\n  actions.setWebpackConfig({\n    plugins: [\n      million.webpack({ mode: 'react', server: true, auto: true }),\n      MillionLint.webpack(),\n    ],\n  })\n};"}},{name:"vite",label:"Vite",bundler:"vite",prefix:"MillionLint.vite",configFilePath:"vite.config.js",possibleFileNames:["vite.config.js","vite.config.mjs","vite.config.cjs","vite.config.ts"],million:{configFileContent:"import million from 'million/compiler';\nimport react from \"@vitejs/plugin-react\";\nimport { defineConfig } from 'vite';\n\nexport default defineConfig({\n  plugins: [million.vite({ auto: true }), react()],\n});"},millionLint:{configFileContent:"import MillionLint from '@million/lint';\nimport react from \"@vitejs/plugin-react\";\nimport { defineConfig } from 'vite';\n\nexport default defineConfig({\n  plugins: [MillionLint.vite(), react()],\n});"},millionAndMillionLint:{configFileContent:"import million from 'million/compiler';\nimport MillionLint from '@million/lint';\nimport react from \"@vitejs/plugin-react\";\nimport { defineConfig } from 'vite';\n\nexport default defineConfig({\n  plugins: [\n    million.vite({ auto: true }),\n    MillionLint.vite(),\n    react(),\n  ],\n});"}},Q,{name:"webpack",label:"Webpack",bundler:"webpack",prefix:"MillionLint.webpack",configFilePath:"webpack.config.js",possibleFileNames:["webpack.config.js","webpack.config.cjs","webpack.config.mjs","webpack.config.ts"],million:{configFileContent:"const million = require('million/compiler');\nmodule.exports = {\n  plugins: [\n    million.webpack({ auto: true }),\n  ],\n};"},millionLint:{configFileContent:"const MillionLint = require('@million/lint').default;\nconst MillionLint = require('@million/lint').default;\nmodule.exports = {\n  plugins: [\n    MillionLint.webpack(),\n  ],\n};"},millionAndMillionLint:{configFileContent:"const million = require('million/compiler');\nconst MillionLint = require('@million/lint').default;\nmodule.exports = {\n  plugins: [\n    million.webpack({ auto: true }),\n    MillionLint.webpack(),\n  ],\n};"}},{name:"rollup",label:"Rollup",bundler:"rollup",prefix:"MillionLint.rollup",configFilePath:"rollup.config.js",possibleFileNames:["rollup.config.js","rollup.config.mjs","rollup.config.cjs","rollup.config.ts"],million:{configFileContent:"import million from 'million/compiler';\n\nexport default {\n  plugins: [million.rollup({ auto: true })],\n};"},millionLint:{configFileContent:"import MillionLint from '@million/lint';\n\nexport default {\n  plugins: [MillionLint.rollup()],\n};"},millionAndMillionLint:{configFileContent:"import million from 'million/compiler';\nimport MillionLint from '@million/lint';\n\nexport default {\n  plugins: [\n    million.rollup({ auto: true }),\n    MillionLint.rollup(),\n  ],\n};"}}];function ee(e,n,t,o=1){const l=b.diffWords(e,n);let r="";l.forEach(((e,n)=>{const i=n>0&&(l[n-1]?.added||l[n-1]?.removed),t=n<l.length-1&&(l[n+1]?.added||l[n+1]?.removed);let a="";if(e.added)a=M(j(e.value));else if(e.removed)a=F(e.value);else if(i&&t){const n=e.value.split("\n");a=n.length-1>2*o?[n.slice(0,o).join("\n"),"...",n.slice(-o-1).join("\n")].join("\n"):L(e.value)}else i?a=e.value.split("\n").slice(0,o+1).join("\n"):t&&(a=e.value.split("\n").slice(-o-1).join("\n"));r+=a})),i.note(r,`Take a look at changes in ${N(t)}`)}var ne=g.promisify(m);async function ie({packageManager:e,packageNames:n,flags:t=[],cwd:o}){"yarn"!==e.name&&"pnpm"!==e.name||t.push("--ignore-workspace-root-check");const{stderr:l}=await ne(`${e.installCommand} ${n.map((e=>`${e}@latest`)).join(" ")} ${t.join(" ")}`,{cwd:o});if(l){i.log.error(F(l)),"npm"===e.name&&t.push("--legacy-peer-deps");try{const{stderr:l}=await ne(`${e.installCommand} ${n.map((e=>`${e}@latest`)).join(" ")} ${t.join(" ")}`,{cwd:o});l&&i.log.error(F(l))}catch(e){q({event:"wizard-failed-install-package",message:e.stdout||e.stderr||e.message,properties:{body:e},needAbort:!0})}}}var te=null;async function oe(e){if(te)return te;const n=await async function(e){const n=await d({cwd:e});if(!n)return null;const[i]=n.split("@");switch(i){case"yarn":return H;case"pnpm":return G;case"npm":return Y;case"bun":return Z;default:return null}}(e),t=await W(i.select({message:"Please select your package manager.",options:K.map((e=>({value:e,label:e.label,hint:`Be sure you have ${j(e.label)} installed.`}))),initialValue:n||void 0}));return te=t}async function le({packageNames:e,alreadyInstalledPackageNames:n,askBeforeUpdating:t=!0,cwd:o,installVSCode:l=!0,packageManager:r}){const a=e.map((e=>N(j(e)))).join(", "),s=n?.map((e=>N(j(e)))).join(", ");if(s?.length&&t){if(!await W(i.confirm({message:`The ${s} package is already installed. Do you want to update it to the latest version?`})))return}r=r||await oe(o);const c=i.spinner();c.start(`${n?.length?"Updating":"Installing"} ${a} with ${j(r.label)}.`);try{await ie({packageManager:r,packageNames:e,cwd:o}),q({type:"info",event:"wizard-package-manager",properties:{body:JSON.stringify(r)}}),c.stop(`${n?.length?"Updated":"Installed"} ${a} with ${j(r.label)}.`)}catch(e){q({event:"wizard-failed-install",message:e,properties:{body:e}});const n="npm"===r.name&&e.message.includes("npm ERR"),t="yarn"===r.name&&e.message.includes("error "),o="pnpm"===r.name&&e.message.includes("ERR_"),l="bun"===r.name&&e.message.includes("error: "),a=n||t||o||l?"Error":"Warnings";i.log.error(F(`${a} during installation. ${e}`)),c.stop();if(!await W(i.confirm({message:"Would you like to continue anyway?"})))return q({event:"wizard-abort",properties:{body:e.message},needAbort:!0})}if(l){const e=i.spinner();try{e.start("Installing VSCode extension.");const i=await async function(){const{stdout:e}=await ne("code --install-extension million.million-lint --force");return e.includes("already installed")?"VSCode extension already installed.":e.includes("not found")?"Code CLI not found. Try installing the extension manually. Search for 'million lint' in the extensions marketplace.":null}();q({type:"info",event:"wizard-vscode-install",properties:{body:JSON.stringify(i)}}),i?e.stop(i):e.stop((n?.length?"Updated":"Installed")+" VSCode extension.")}catch(n){q({event:"wizard-vscode-failed-install",properties:{body:n}}),i.log.error(F("Could not install VSCode extension. Look up 'million-lint' in the extensions marketplace to install manually.")),e.stop();if(!await W(i.confirm({message:"Would you like to continue anyway?"})))return q({event:"wizard-abort",message:"VSCode extension installation failed.",properties:{body:n.message},needAbort:!0})}}}function re(e){return!!e&&!!e.includes("react-scripts start")}async function ae(n,t,o){if(re(n)){let l=n;l=l.replace("react-scripts start","craco start"),l=l.replace("react-scripts build","craco build"),l=l.replace("react-scripts test","craco test");const r=["@craco/craco",...t].map((e=>N(j(e)))).join(", ");try{const n=await oe(o);await p.promises.writeFile(e.join(o,"package.json"),l),t.includes("million")&&t.includes("@million/lint")?await p.promises.writeFile(e.join(o,"craco.config.js"),Q.millionAndMillionLint.configFileContent):t.includes("million")?await p.promises.writeFile(e.join(o,"craco.config.js"),Q.million.configFileContent):t.includes("@million/lint")&&await p.promises.writeFile(e.join(o,"craco.config.js"),Q.millionLint.configFileContent);const a=i.spinner();a.start(`Installing ${r}...`),await ie({packageManager:n,packageNames:["@craco/craco"],cwd:o,flags:["-D"]}),await ie({packageManager:n,packageNames:t,cwd:o}),a.stop(`${r} installed.`)}catch(e){return q({event:"wizard-error-install-craco",message:`Could not install ${r}. Please install it manually.`,properties:{body:e}})}}}var se=new Set(["<",">","{","}","[","]"]),ce=new Set(["for","do","while","if","else","return","function","var","let","const","true","false","undefined","this","new","delete","typeof","in","instanceof","void","break","continue","switch","case","default","throw","try","catch","finally","debugger","with","yield","async","await","class","extends","super","import","export","from","static"]),pe=new Set(["+","-","*","/","%","=","!","&","|","^","~","!","?",":",".",",",";","'",'"',".","(",")","[","]","#","@","\\",...se]),[fe,de,ue,me,ge,be,ye,we,he,ve,xe]=["identifier","keyword","string","class","property","entity","jsxliterals","sign","comment","break","space"].map(((e,n)=>n));function ke(e){return/^[^\S\r\n]+$/g.test(e)}function Ce(e){return pe.has(e)}function je(e){return/^[\w_]+$/.test(e)||Le(e)}function Le(e){return/[^\u0000-\u007f]/.test(e)}function Fe(e){return/^[a-zA-Z]$/.test(e)}function Me(e){return Fe(e)||Le(e)}function Se(e){return Me(e[0])&&(1===e.length||je(e.slice(1)))}function Pe(e){return"`"===e}function $e(e){return'"'===e||"'"===e}function Ne(e){return"//"===(e=e.slice(0,2))||"/*"===e}function ze(e){let n="",i=-1,t=[-1,""],o=[-2,""];const l=[];let r=!1,a=0,s=!1,c=0;const p=()=>r&&!s&&!a,f=()=>a&&!p(),d=()=>!a&&p()&&!s&&c>0;let u=null,m=0,g=0;const b=()=>null!==u,y=()=>g>m,w=()=>b()||y();function h(e){const n="\n"===e;if(f()){if(b())return ue;const[,n]=t;if(Se(e)&&("<"===n||"</"===n))return be}if(d())return ye;if(b())return ue;if(ce.has(e))return"."===t[1]?fe:de;if(n)return ve;if(ke(e))return xe;if(e.split("").every(Ce))return we;if(function(e){const n=e[0];return je(n)&&n===n.toUpperCase()||"null"===e}(e))return f()?fe:me;if(Se(e)){const e="."===t[1]&&Se(o[1]);if(!w()&&!e)return fe;if(e)return ge}return ue}const v=(e,r)=>{if(r&&(n=r),n){i=e||h(n);const r=[i,n];i!==xe&&i!==ve&&(o=t,t=r),l.push(r)}n=""};for(let i=0;i<e.length;i++){const o=e[i],l=e[i-1],f=e[i+1],b=l+o,h=o+f;if($e(o)&&!d()){v(),"\\"!==l&&(u&&o===u?u=null:u||(u=o)),v(ue,o);continue}if(!y()&&"\\n"!==l&&Pe(o)){v(),v(ue,o),g++;continue}if(y()){if("\\n"!==l&&Pe(o)&&g>0){v(),g--,v(ue,o);continue}if("${"===h){m++,v(ue),v(we,h),i++;continue}}if(g>0&&g===m&&"}"===o){v(),m--,v(we,o);continue}if(p()&&"{"===o){v(),v(we,o),s=!0;continue}if(r){if(!a&&"<"===o){v(),"/"===f?(a=2,n=h,i++):(a=1,n=o),v(we);continue}if(a){if(">"===o&&!"/=".includes(l)){v(),1===a?(a=0,c++):(a=0,r=!1),v(we,o);continue}if("/>"===h||"</"===h){"<"!==n&&"/"!==n&&v(),"/>"===h?a=0:c--,c||(r=!1),n=h,i++,v(we);continue}if("<"===o){v(),n=o,v(we);continue}if("-"===f&&!w()&&!d()&&n){v(ge,n+o+f),i+=1;continue}if("="===f&&!w()){const e=n?n+o:o;Se(e)&&(n=e,v(ge));continue}}}!a&&("<"===o&&Me(f)||"</"===h)&&(a="/"===f?2:1,"<"!==o||"/"!==f&&!Fe(f)||(r=!0));const C=$e(k=o)||Pe(k),j=y(),L=!r&&("/"===(x=h)[0]&&!Ne(x[0]+x[1])),F=d();if(C||j||$e(u))n+=o;else if(L){v();const[l,r]=t;if(L&&-1!==l&&(l!==we||")"===r)&&l!==he){n=o,v();continue}const a=i++,s=()=>i>=e.length,c=()=>s()||"\n"===e[i];let p=!1;for(;!c();i++)if("/"===e[i]&&"\\"!==e[i-1]){for(p=!0;a!==i&&/^[a-z]$/.test(e[i+1])&&!c();)i++;break}a!==i&&p?(n=e.slice(a,i+1),v(ue)):(n=o,v(),i=a)}else if(Ne(h)){v();const t=i;if("/"===f)for(;i<e.length&&"\n"!==e[i];i++);else for(;i<e.length&&e[i-1]+e[i]!=="*/";i++);n=e.slice(t,i+1),v(he)}else" "===o||"\n"===o?" "!==o||!ke(n)&&n&&!F?(v(),n=o,v()):(n+=o,"<"===f&&v()):s&&"}"===o?(v(),n=o,v(),s=!1):F&&!se.has(o)||(je(o)===je(n[n.length-1])||p())&&!pe.has(o)?n+=o:("</"===b&&(n=b),v(),"</"!==b&&(n=o),"</"===h||"/>"===h?(n=h,v(),i++):se.has(o)&&v())}var x,k;return v(),l}function Ie(e,n={showLineNumbers:!1}){const i=ze(e),t=[];let o=1;const l=[];function r(e){t.push(function(e){const i=n.showLineNumbers?`${L(`${o}`.padEnd(2," "))} `:"";return o++,`${i}${e}`}(e.map((([e,n])=>{switch(e){case 0:case 4:return $(n);case 1:case 2:case 7:return I(n);case 3:return S(n);case 5:return P(n);case 6:return z(n);case 8:return L(n);default:return n}})).join("")))}for(const e of i){const[n,i]=e;if(9!==n)if(i.includes("\n")){const e=i.split("\n");for(let i=0;i<e.length;i++)l.push([n,e[i]]),i<e.length-1&&(r(l),l.length=0)}else l.push(e);else l.push([n,""]),r(l),l.length=0}return l.length>0&&r(l),t.join("\n")}async function Ee(n,t,o){let l;i.note(`found existing ${n.configFilePath} file.`,`Transforming ${N(n.configFilePath)}`);try{let r=await async function(n,i){const t=e.join(i,n.configFilePath);return await c.readFile(t,{encoding:"utf-8"})}(n,o);const a=r,s=e.join(o,n.configFilePath);let f=!1;for(const e of t)"@million/lint"===e?r.includes("@million/lint")&&(f=!0):"million"===e&&(r.includes("million/compiler")||r.includes("million"))&&(f=!0);f&&q({event:"wizard-already-configured",message:F(`@million/lint is already configured in ${n.configFilePath}.`),needAbort:!0});const d=i.spinner(),u=function(e){if(e.includes("module.exports =")||e.includes("exports."))return"cjs";if(e.includes("export default"))return"esm";return"unknown"}(r);if(q({event:"wizard-modify-config",properties:{body:{type:u,oldCode:a,filePath:s}}}),"unknown"===u)return q({event:"wizard-unknown-module-type",message:"Unknown module type. Aborting.",needAbort:!0});let m,g,b;t.forEach((e=>{"million"===e?r=("esm"===u?"import million from 'million/compiler';\n":"const million = require('million/compiler');\n")+r:"@million/lint"===e&&(r=("esm"===u?"import MillionLint from '@million/lint';\n":"const MillionLint = require('@million/lint');\n")+r)})),"next"===n.name&&(m=await async function(){return p.existsSync("pages")?"pages":p.existsSync("app")?"app":p.existsSync("src/pages")?"pages":p.existsSync("src/app")?"app":await W(i.select({message:"Will you use app Router or pages Router?",options:[{label:"App Router",value:"app"},{label:"Pages Router",value:"pages"}]}))}()),d.start(`Modifying config file ${N(n.configFilePath)}...`),t.includes("million")&&t.includes("@million/lint")?(g=n.millionAndMillionLint.configFileContent,b=n.millionAndMillionLint.configFileContentRSC):t.includes("million")?(g=n.million.configFileContent,b=n.million.configFileContentRSC):t.includes("@million/lint")&&(g=n.millionLint.configFileContent,b=n.millionLint.configFileContentRSC),l="app"===m?b:g;const h=await async function(e,n,i,t,o){const{name:l,bundler:r}=n;try{const n=(e,n,t)=>{const a=n(e),s=e=>w.callExpression(w.memberExpression(w.identifier("million"),w.identifier(r)),"astro"===l||"gatsby"===l?[w.objectExpression([w.objectProperty(w.identifier("mode"),w.stringLiteral("react")),w.objectProperty(w.identifier("server"),w.booleanLiteral(!0)),w.objectProperty(w.identifier("auto"),w.booleanLiteral(!0))])]:"next"===l?[e,w.objectExpression([w.objectProperty(w.identifier("auto"),w.booleanLiteral(!0))])]:[w.objectExpression([w.objectProperty(w.identifier("auto"),w.booleanLiteral(!0))])]),c=()=>w.callExpression(w.memberExpression(w.identifier("MillionLint"),w.identifier(r)),"craco"===l?[w.objectExpression([w.objectProperty(w.identifier("legacyHmr"),w.booleanLiteral(!0))])]:o?[w.objectExpression([w.objectProperty(w.identifier("rsc"),w.booleanLiteral(!0))])]:[]),p=()=>{const e=[];return i.includes("million")&&e.push(s()),i.includes("@million/lint")&&e.push(c()),e};if("next"===l){if(w.isClassDeclaration(a)||w.isFunctionDeclaration(a)||w.isTSDeclareFunction(a))return;i.includes("million")&&i.includes("@million/lint")?t(s(w.callExpression(c(),[a]))):i.includes("million")?t(s(a)):i.includes("@million/lint")&&t(w.callExpression(c(),[a]))}if("vite"===l||"webpack"===l||"rollup"===l||"esbuild"===l||"rspack"===l||"craco"===l||"gatsby"===l||"astro"===l){let n=!1;if(e.traverse({ObjectProperty(i){if("craco"===l){if(w.isIdentifier(i.node.key)&&"plugins"===i.node.key.name&&w.isProperty(i.node)&&!w.isPattern(i.node.value)&&!w.isRestElement(i.node.value)&&!w.isIdentifier(i.node.value)){let t;n=!0,t=w.isObjectExpression(i.node.value)&&i.node.value.properties.some((e=>w.isObjectProperty(e)&&w.isIdentifier(e.key)&&"add"===e.key.name))?i.node.value.properties.find((e=>w.isObjectProperty(e)&&w.isIdentifier(e.key)&&"add"===e.key.name)):w.objectProperty(w.identifier("add"),w.arrayExpression(p())),e.insertBefore([w.variableDeclaration("const",[w.variableDeclarator(w.identifier("_plugins"),t.value)]),w.callExpression(w.memberExpression(w.identifier("_plugins"),w.identifier("unshift")),p())]),w.isObjectExpression(i.node.value)&&(i.node.value.properties=i.node.value.properties.filter((e=>!(w.isObjectProperty(e)&&w.isIdentifier(e.key)&&"add"===e.key.name))),i.node.value.properties.push(w.objectProperty(w.identifier("add"),w.identifier("_plugins"))))}}else!w.isIdentifier(i.node.key)||"plugins"!==i.node.key.name||!w.isProperty(i.node)||w.isPattern(i.node.value)||w.isRestElement(i.node.value)||w.isIdentifier(i.node.value)||(n=!0,e.insertBefore([w.variableDeclaration("const",[w.variableDeclarator(w.identifier("_plugins"),i.node.value)]),w.callExpression(w.memberExpression(w.identifier("_plugins"),w.identifier("unshift")),p())]),i.node.value=w.identifier("_plugins"))}}),!n){let n;const i=w.variableDeclaration("const",[w.variableDeclarator(w.identifier("_plugins"),w.arrayExpression(p()))]),t=w.objectProperty(w.identifier("plugins"),w.identifier("_plugins"));if(e.insertBefore([i]),"astro"===l){let e;a&&"CallExpression"===a.type&&w.isIdentifier(a.callee)&&"defineConfig"===a.callee.name&&(n=a.arguments[0]),n?.properties.length?e=n.properties.find((e=>!("ObjectProperty"!==e.type||!w.isIdentifier(e.key)||"vite"!==e.key.name||"ObjectExpression"!==e.value.type)))||w.objectProperty(w.identifier("vite"),w.objectExpression([t])):(e=w.objectProperty(w.identifier("vite"),w.objectExpression([t])),n=w.objectExpression([e])),a&&"CallExpression"===a.type&&w.isIdentifier(a.callee)&&"defineConfig"===a.callee.name&&(a.arguments[0]=n)}else"gatsby"===l?e.traverse({CallExpression(e){w.isMemberExpression(e.node.callee)&&w.isIdentifier(e.node.callee.property)&&"setWebpackConfig"===e.node.callee.property.name&&(n=e.node.arguments[0]),n?.properties.length?n.properties.push(t):n=w.objectExpression([t]),w.isMemberExpression(e.node.callee)&&w.isIdentifier(e.node.callee.property)&&"setWebpackConfig"===e.node.callee.property.name&&(e.node.arguments[0]=n)}}):"craco"===l?w.isObjectExpression(a)&&a.properties.push(w.objectProperty(w.identifier("webpack"),w.objectExpression([w.objectProperty(w.identifier("add"),w.identifier("_plugins"))]))):w.isObjectExpression(a)&&a.properties.push(t)}}},t=()=>({name:"wizard",visitor:{MemberExpression(e){const i=w.isIdentifier(e.node.object)&&"module"===e.node.object.name&&w.isIdentifier(e.node.property)&&"exports"===e.node.property.name,t=w.isIdentifier(e.node.object)&&"exports"===e.node.object.name;if(i||t){if(!w.isAssignmentExpression(e.parent))return;n(e.parentPath,(e=>e.node.right),(n=>{e.node.right=n}))}},ExportDefaultDeclaration(e){n(e,(e=>e.node.declaration),(n=>{e.node.declaration=n}))}}}),a=await y(e,{plugins:[t()],parserOpts:{plugins:["jsx","typescript"]}});return a?(q({type:"info",event:"wizard-success-modify-config",properties:{body:JSON.stringify(a)}}),a.code):null}catch(e){return q({event:"wizard-failed-get-new-file-content",message:`Unable to modify config file.\n\nHere is an installation reference:\n\n${Ie(t,{showLineNumbers:!0})}`,properties:{body:e},needAbort:!0}),null}}(r,n,t,l,"app"===m);if(!h)return q({event:"wizard-no-changes-made",message:`Reverted the changes.\n\nHere is an installation reference:\n\n${Ie(l,{showLineNumbers:!0})}`,needAbort:!0});await c.writeFile(s,h,{encoding:"utf-8",flag:"w"}),d.stop(`Modified config file ${N(n.configFilePath)}.`),ee(a,h,n.configFilePath);const v=async()=>{await c.writeFile(s,a,{encoding:"utf-8",flag:"w"}),q({event:"wizard-reverted-changes",message:`Reverted the changes.\n\nHere is an installation reference:\n\n${Ie(l,{showLineNumbers:!0})}`,needAbort:!0})};await W(i.confirm({message:"Does the config file look good?",initialValue:!0}),v)||await v()}catch(e){return i.log.error(e),q({event:"wizard-failed-modify-config",message:`Failed to modify config file.\n\nHere is an installation reference:\n\n${Ie(l,{showLineNumbers:!0})}`,needAbort:!0})}}async function Ae(){const t=e.join(n.cwd());await i.group({packageDotJson:async()=>await U(t),selectPackages:async({results:e})=>{if(!e.packageDotJson)return;return await i.multiselect({message:"Please select the packages you want to install",options:[{value:"@million/lint",label:"Million Lint"},{value:"million",label:"Million.js"}],initialValues:["million","@million/lint"],required:!0})},buildTool:async({results:n})=>{if(!n.packageDotJson||!n.selectPackages?.length)return;const o=await async function({packageJsonContents:n,packages:t,cwd:o}){const l=[];for(const r of X){if("craco"===r.name&&re(n))return await W(await i.confirm({message:"Ordinary create-react-app projects are not supported. Do you want to use craco instead of react-scripts?"}))?void await ae(n,t,o):void q({event:"wizard-craco-not-installed",message:"Please install craco manually: https://craco.js.org/docs/getting-started",needAbort:!0});for(const n of r.possibleFileNames)if(p.existsSync(e.join(o,n))){const e={...r,configFilePath:n};l.push({buildTool:e})}else if(p.existsSync(e.join(o,"config",n))){const i={...r,configFilePath:e.join("config",n)};l.push({buildTool:i})}if("gatsby"===r.name)for(const n of r.otherPossibleFileNames)if(p.existsSync(e.join(o,n))){const n=r;t.includes("million")&&t.includes("@million/lint")?await p.promises.writeFile(e.join(o,r.configFilePath),r.millionAndMillionLint.configFileContent):t.includes("million")?await p.promises.writeFile(e.join(o,r.configFilePath),r.million.configFileContent):t.includes("@million/lint")&&await p.promises.writeFile(e.join(o,r.configFilePath),r.millionLint.configFileContent),l.push({buildTool:n,skipUpdateConfigFile:!0})}}if(l.length){if(1===l.length)return i.log.success(`Detected ${N(j(l[0].buildTool.label))} project.`),l[0];const e=await W(await i.select({message:"Detected multiple build tools. Please select one:",options:l.map((e=>({label:e.buildTool.label,value:e.buildTool.name,hint:e.buildTool.configFilePath}))),initialValue:l[0].buildTool.name}));return l.find((n=>n.buildTool.name===e))}q({event:"wizard-no-build-tool-detected",message:`No build tool detected. No configuration file found in the current path: ${o}`,needAbort:!0})}({packageJsonContents:n.packageDotJson.packageJsonContents,packages:n.selectPackages,cwd:t}),{buildTool:l,skipUpdateConfigFile:r}=o||{};return{buildTool:l,skipUpdateConfigFile:r}},install:async({results:e})=>{if(!e.packageDotJson||!e.buildTool?.buildTool||!e.selectPackages?.length)return;const n=await async function(e,n=["@million/lint"]){const i=[],t=await U(e),o=t?.packageJson;for(const e of n)o?.dependencies?.[e]&&i.push(e);return i}(t,e.selectPackages);await le({packageNames:e.selectPackages,alreadyInstalledPackageNames:n,cwd:t,installVSCode:e.selectPackages.includes("@million/lint")})},updateConfigFile:async({results:e})=>{e.buildTool?.buildTool&&(e.buildTool?.skipUpdateConfigFile||e.selectPackages?.length&&await Ee(e.buildTool.buildTool,e.selectPackages,t))},other:async({results:n})=>{n.buildTool?.buildTool&&(n.buildTool?.skipUpdateConfigFile||n.selectPackages?.length&&await async function(n){if(!n)return;const i="# Million Lint\n.million\n",t=e.join(n,".gitignore");if(f.existsSync(t)){const e=await c.readFile(t,"utf-8");if(e.includes(".million"))return;const n=`${e}\n${i}`;await c.writeFile(t,n),ee(e,n,t)}else{const e=i;await c.writeFile(t,e),ee("",e,t)}}(t))}},{onCancel:({results:e})=>{q({event:"wizard-cancel",properties:{body:e}}),i.cancel("Million Lint setup cancelled."),J().then((()=>n.exit(1)))}}),q({type:"info",event:"wizard-complete",properties:{body:!0}}),J().then((()=>n.exit(1)))}async function Te(n){try{i.intro(P(`⚡ ${j("Million Lint beta")}`)),await async function(n){const t=e.join(process.cwd());await i.group({getVersions:async()=>{const e=i.spinner();try{let{npmVersion:t,vscodeVersion:o}=n.reduce(((e,n)=>{try{const[i,t]=n.split("=");return{...e,[i.split("--")[1]]:t}}catch{return e}}),{npmVersion:"",vscodeVersion:""});if(!t||!o){e.start("Fetching latest versions");let n="version.txt";t?n=`version-npm-${t}.txt`:o&&(n=`version-vscode-${o}.txt`);const i=await fetch(`https://beta-lint-r2.million.dev/${n}`).then((e=>e.text())).then((e=>{const[n,i]=e.split("\n");return{npm:t||n,vscode:o||i}}));t=i.npm,o=i.vscode,e.stop()}return i.note(`Downloading packages for NPM ${t} and VSCode ${o}`,"Get ready to install the packages."),{npmVersion:t,vscodeVersion:o}}catch(n){return e.stop(),q({event:"beta-error",message:"Failed to fetch versions",properties:{body:n}})}},fetchPackages:async({results:n})=>{if(!n.getVersions)return;const o=i.spinner();try{const{npmVersion:i,vscodeVersion:l}=n.getVersions;o.start("Downloading packages");const r=await fetch(`https://beta-lint-r2.million.dev/million-lint-${i}.tgz`).then((e=>e.arrayBuffer())).then((e=>Buffer.from(e))),a=e.join(t,`million-lint-${i}.tgz`);await c.writeFile(a,r);const s=await fetch(`https://beta-lint-r2.million.dev/million-lint-${l}.vsix`).then((e=>e.arrayBuffer())).then((e=>Buffer.from(e))),p=e.join(t,`million-lint-${l}.vsix`);await c.writeFile(p,s),o.message(`Downloaded packages: NPM ${i}, VSCode ${l}`);const f=await d({programmatic:!0,cwd:t});if(!f)return q({event:"beta-error",message:"No package manager found",properties:{body:"No package manager found"}});const m=await u(f,[a]);if(!m)return q({event:"beta-error",message:"Failed to create install command",properties:{body:"Failed to create install command"}});const{stderr:g}=await ne(m);if(g)return q({event:"beta-error",message:"Failed to install packages",properties:{body:g}});const b=`code --install-extension ${p}`,{stderr:y}=await ne(b);if(y)return q({event:"beta-error",message:"Failed to install packages",properties:{body:y}});await c.unlink(a),await c.unlink(p),o.stop()}catch(e){return o.stop(),q({event:"beta-error",message:"Failed to fetch packages",properties:{body:e}})}}},{onCancel:({results:e})=>{q({event:"beta-cancel",properties:{body:e}}),i.cancel("Million beta cancelled."),J().then((()=>process.exit(1)))}})}(n),i.outro(`${M(j("✓ "))} You're all set! Enjoy! 🎉`)}catch(e){q({event:"beta-error",message:e,properties:{body:e}})}}async function Ve(i,l=n.env.VERSION){try{n.env.MILLION_INSTALL_NAME=i||"",n.env.MILLION_INSTALL_VERSION=l||"",n.env.MILLION_INSTALL_ROOT=e.join(n.cwd()),t(P(`⚡ ${j(i)} ${L(l||"")}`)),await Ae(),o(`${M(j("✓ "))} You're all set!`)}catch(e){q({event:"wizard-error",message:e,properties:{body:e}})}}export{Te as beta,Ve as install};