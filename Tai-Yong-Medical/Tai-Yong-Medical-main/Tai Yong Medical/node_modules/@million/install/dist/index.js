"use strict";var e=require("path"),n=require("process"),i=require("@clack/prompts"),t=require("tty"),o=require("posthog-node"),l=require("crypto"),r=require("@axiomhq/js"),a=require("fs/promises"),s=require("fs"),c=require("@antfu/ni"),u=require("child_process"),p=require("util"),f=require("diff"),d=require("@babel/core"),m=require("@babel/types");function g(e){return e&&e.__esModule?e:{default:e}}function b(e){if(e&&e.__esModule)return e;var n=Object.create(null);return e&&Object.keys(e).forEach((function(i){if("default"!==i){var t=Object.getOwnPropertyDescriptor(e,i);Object.defineProperty(n,i,t.get?t:{enumerable:!0,get:function(){return e[i]}})}})),n.default=e,Object.freeze(n)}var y,w=g(e),h=g(n),v=b(i),x=g(a),k=b(s),C=g(p),j=b(f),L=b(m),F={reset:[0,0],bold:[1,22],dim:[2,22],italic:[3,23],underline:[4,24],overline:[53,55],inverse:[7,27],hidden:[8,28],strikethrough:[9,29],black:[30,39],red:[31,39],green:[32,39],yellow:[33,39],blue:[34,39],magenta:[35,39],cyan:[36,39],white:[37,39],gray:[90,39],bgBlack:[40,49],bgRed:[41,49],bgGreen:[42,49],bgYellow:[43,49],bgBlue:[44,49],bgMagenta:[45,49],bgCyan:[46,49],bgWhite:[47,49],bgGray:[100,49],redBright:[91,39],greenBright:[92,39],yellowBright:[93,39],blueBright:[94,39],magentaBright:[95,39],cyanBright:[96,39],whiteBright:[97,39],bgRedBright:[101,49],bgGreenBright:[102,49],bgYellowBright:[103,49],bgBlueBright:[104,49],bgMagentaBright:[105,49],bgCyanBright:[106,49],bgWhiteBright:[107,49],blackStylize:["#121212","#eeeeee18"],redStylize:["#cb7676","#ab5959"],greenStylize:["#4d9375","#1e754f"],yellowStylize:["#f6c177","#f6c17790"],blueStylize:["#6394bf","#296aa3"],magentaStylize:["#c391e6","#c391e690"],pinkStylize:["#ed9cc2","#ed9cc290"],cyanStylize:["#5eaab5","#2993a3"],whiteStylize:["#ffffff","#ffffff9f"],grayStylize:["#888888","#444444"]},M=t.WriteStream.prototype.hasColors(),S=(e,n)=>{if(!M)return e=>e;const i=`[${e}m`,t=`[${n}m`;return e=>{const n=`${e}`;let o=n.indexOf(t);if(-1===o)return i+n+t;let l=i,r=0;for(;-1!==o;)l+=n.slice(r,o)+i,r=o+t.length,o=n.indexOf(t,r);return l+=n.slice(r)+t,l}},P=(y=(e,n,i)=>S(`38;2;${e};${n};${i}`,39),e=>{const[n,i,t]=(e=>{let[,n]=/([\da-f]{3,6})/i.exec(e)||[];const i=n?n.length:0;if(3===i)n=n[0]+n[0]+n[1]+n[1]+n[2]+n[2];else if(6!==i)return[0,0,0];const t=Number.parseInt(n,16);return[t>>16&255,t>>8&255,255&t]})(e);return y(n,i,t)}),$=S(...F.bold),N=S(...F.dim);P(F.blackStylize[0]),P(F.blackStylize[1]);var z=P(F.redStylize[0]);P(F.redStylize[1]);var I=P(F.greenStylize[0]);P(F.greenStylize[1]);var E=P(F.yellowStylize[0]);P(F.yellowStylize[1]),P(F.blueStylize[0]),P(F.blueStylize[1]);var A=P(F.magentaStylize[0]);P(F.magentaStylize[1]);var O=P(F.pinkStylize[0]);P(F.pinkStylize[1]);var T=P(F.cyanStylize[0]);P(F.cyanStylize[1]),P(F.whiteStylize[0]);var V=P(F.whiteStylize[1]),q=P(F.grayStylize[0]);P(F.grayStylize[1]);var R,_,B="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict",D=128;function W(e=21){var n;n=e-=0,!R||R.length<n?(R=Buffer.allocUnsafe(n*D),l.webcrypto.getRandomValues(R),_=0):_+n>R.length&&(l.webcrypto.getRandomValues(R),_=0);let i="";for(let t=(_+=n)-e;t<_;t++)i+=B[63&R[t]];return i}var J=new r.Axiom({token:"xaat-137e6732-9a45-48d9-b12c-964c9fa88ed3"}),U=async(e,...n)=>{J.ingest("install",{level:e,env:{name:process.env.MILLION_INSTALL_NAME,version:process.env.MILLION_INSTALL_VERSION,root:process.env.MILLION_INSTALL_ROOT},message:JSON.stringify(n)}),await J.flush()},H=J.flush,G=new o.PostHog("phc_dnFdhVY0JlEpyRhxewVBWgV7StMjHPFG7NbTPG26TNN",{host:"https://app.posthog.com",flushAt:1,flushInterval:0});function Y({type:e="error",distinctId:n=`r-${W(10)}`,event:i,message:t,properties:o={},needAbort:l}){if(l)return function({title:e,message:n,properties:i={},status:t,distinctId:o=`r-${W(10)}`}){U("error",{distinctId:o,title:e,message:n,...i}),n&&v.log.error(n);v.log.error(`${z("Setup failed.")} Continue via ${T("http://million.dev/docs#manual-installation")}`),v.log.message(),G.capture({distinctId:o,event:"wizard-abort",properties:{body:{title:e,message:n,...i}}}),Z().then((()=>process.exit(t??1)))}({title:i,message:t});t?("error"===e?v.log.error(t):v.note(t,i),U(e,{distinctId:n,event:i,message:t,...o})):U(e,{distinctId:n,event:i,...o}),G.capture({distinctId:n,event:i,properties:o})}var Z=async()=>{try{return await H(),G.shutdownAsync()}catch{process.exit(1)}};async function K(e,n){const i=await e;if(!v.isCancel(i))return e;Y({event:"wizard-cancel",properties:{body:i}}),n&&await n(),v.cancel("Million Lint setup cancelled."),await Z(),process.exit(1)}async function Q(e){const n=await async function(e){let n;try{n=await x.default.readFile(w.default.join(e,"package.json"),"utf8")}catch{return void Y({event:"wizard-package-json-not-found",message:"Could not find package.json. Make sure to run the wizard in the root of your app!"})}return n}(e);if(!n)return;let i;try{i=JSON.parse(n)}catch{return Y({event:"wizard-package-json-parse-error",message:"Unable to parse your package.json. Make sure it has a valid format!",needAbort:!0})}return{packageJson:i,packageJsonContents:n}}var X={name:"yarn",label:"yarn",lockFile:"yarn.lock",installCommand:"yarn add",dlxCommand:"npx"},ee={name:"pnpm",label:"pnpm",lockFile:"pnpm-lock.yaml",installCommand:"pnpm install",dlxCommand:"pnpx"},ne={name:"npm",label:"npm",lockFile:"package-lock.json",installCommand:"npm install",dlxCommand:"npx"},ie={name:"bun",label:"bun",lockFile:"bun.lockb",installCommand:"bun add",dlxCommand:"bunx"},te=[ee,X,ie,ne],oe={name:"craco",label:"Create React App",bundler:"webpack",prefix:"MillionLint.craco",configFilePath:"craco.config.js",possibleFileNames:["craco.config.js","craco.config.mjs","craco.config.cjs","craco.config.ts"],million:{configFileContent:"const million = require('million/compiler');\nmodule.exports = {\n  webpack: {\n    plugins: { add: [million.webpack({ auto: true })] }\n  }\n};"},millionLint:{configFileContent:"const MillionLint = require('@million/lint').default;\nmodule.exports = {\n  webpack: {\n    plugins: { add: [MillionLint.webpack({ legacyHmr: true })] }\n  }\n};"},millionAndMillionLint:{configFileContent:"const million = require('million/compiler');\nconst MillionLint = require('@million/lint').default;\nmodule.exports = {\n  webpack: {\n    plugins: {\n      add: [\n        million.webpack({ auto: true }),\n        MillionLint.webpack({ legacyHmr: true }),\n      ]\n    }\n  }\n};"}},le=[{name:"next",label:"Next.js",bundler:"next",prefix:"MillionLint.next",configFilePath:"next.config.mjs",possibleFileNames:["next.config.js","next.config.mjs"],million:{configFileContent:"import million from 'million/compiler';\n\n/** @type {import('next').NextConfig} */\nconst nextConfig = {\n  reactStrictMode: true,\n};\n\nconst millionConfig = {\n  auto: true,\n};\n\nexport default million.next(nextConfig, millionConfig);",configFileContentRSC:"import million from 'million/compiler';\n    \n/** @type {import('next').NextConfig} */\nconst nextConfig = {\n  reactStrictMode: true,\n};\n\nconst millionConfig = {\n  auto: { rsc: true },\n};\n\nexport default million.next(nextConfig, millionConfig);"},millionLint:{configFileContent:"import MillionLint from '@million/lint';\n\n/** @type {import('next').NextConfig} */\nconst nextConfig = {\n  reactStrictMode: true,\n};\n\nexport default MillionLint.next()(nextConfig);",configFileContentRSC:"import MillionLint from '@million/lint';\n\n/** @type {import('next').NextConfig} */\nconst nextConfig = {\n  reactStrictMode: true,\n};\n\nexport default MillionLint.next({ rsc: true })(nextConfig);"},millionAndMillionLint:{configFileContent:"import MillionLint from '@million/lint';\nimport million from 'million/compiler';\n\n/** @type {import('next').NextConfig} */\nconst nextConfig = {\n  reactStrictMode: true,\n};\n\nconst millionConfig = {\n  auto: true,\n};\n\nexport default million.next(MillionLint.next({ rsc: true })(nextConfig), millionConfig);",configFileContentRSC:"import MillionLint from '@million/lint';\nimport million from 'million/compiler';\n\n/** @type {import('next').NextConfig} */\nconst nextConfig = {\n  reactStrictMode: true,\n};\n\nconst millionConfig = {\n  auto: true,\n};\n\nexport default million.next(MillionLint.next({ rsc: true })(nextConfig), millionConfig);"}},{name:"astro",label:"Astro",bundler:"vite",prefix:"MillionLint.vite",configFilePath:"astro.config.mjs",possibleFileNames:["astro.config.js","astro.config.mjs","astro.config.cjs","astro.config.ts"],million:{configFileContent:"import { defineConfig } from 'astro/config';\nimport million from 'million/compiler';\n\nexport default defineConfig({\n  vite: {\n    plugins: [million.vite({ mode: 'react', server: true, auto: true })]\n  }\n});"},millionLint:{configFileContent:"import { defineConfig } from 'astro/config';\nimport MillionLint from '@million/lint';\n\nexport default defineConfig({\n  vite: {\n    plugins: [MillionLint.vite()]\n  }\n});"},millionAndMillionLint:{configFileContent:"import { defineConfig } from 'astro/config';\nimport million from 'million/compiler';\nimport MillionLint from '@million/lint';\n\nexport default defineConfig({\n  vite: {\n    plugins: [\n      million.vite({ mode: 'react', server: true, auto: true }),\n      MillionLint.vite(),\n    ]\n  }\n});"}},{name:"gatsby",label:"Gatsby",bundler:"webpack",prefix:"MillionLint.webpack",configFilePath:"gatsby-node.js",possibleFileNames:["gatsby-node.js","gatsby-node.ts"],otherPossibleFileNames:["gatsby-config.js","gatsby-config.ts"],million:{configFileContent:"const million = require('million/compiler');\n\nexports.onCreateWebpackConfig = ({ actions }) => {\n  actions.setWebpackConfig({\n    plugins: [million.webpack({ mode: 'react', server: true, auto: true })],\n  })\n};"},millionLint:{configFileContent:"const MillionLint = require('@million/lint').default;\n  \nexports.onCreateWebpackConfig = ({ actions }) => {\n  actions.setWebpackConfig({\n    plugins: [MillionLint.webpack()],\n  })\n};"},millionAndMillionLint:{configFileContent:"const million = require('million/compiler');\nconst MillionLint = require('@million/lint').default;\n\nexports.onCreateWebpackConfig = ({ actions }) => {\n  actions.setWebpackConfig({\n    plugins: [\n      million.webpack({ mode: 'react', server: true, auto: true }),\n      MillionLint.webpack(),\n    ],\n  })\n};"}},{name:"vite",label:"Vite",bundler:"vite",prefix:"MillionLint.vite",configFilePath:"vite.config.js",possibleFileNames:["vite.config.js","vite.config.mjs","vite.config.cjs","vite.config.ts"],million:{configFileContent:"import million from 'million/compiler';\nimport react from \"@vitejs/plugin-react\";\nimport { defineConfig } from 'vite';\n\nexport default defineConfig({\n  plugins: [million.vite({ auto: true }), react()],\n});"},millionLint:{configFileContent:"import MillionLint from '@million/lint';\nimport react from \"@vitejs/plugin-react\";\nimport { defineConfig } from 'vite';\n\nexport default defineConfig({\n  plugins: [MillionLint.vite(), react()],\n});"},millionAndMillionLint:{configFileContent:"import million from 'million/compiler';\nimport MillionLint from '@million/lint';\nimport react from \"@vitejs/plugin-react\";\nimport { defineConfig } from 'vite';\n\nexport default defineConfig({\n  plugins: [\n    million.vite({ auto: true }),\n    MillionLint.vite(),\n    react(),\n  ],\n});"}},oe,{name:"webpack",label:"Webpack",bundler:"webpack",prefix:"MillionLint.webpack",configFilePath:"webpack.config.js",possibleFileNames:["webpack.config.js","webpack.config.cjs","webpack.config.mjs","webpack.config.ts"],million:{configFileContent:"const million = require('million/compiler');\nmodule.exports = {\n  plugins: [\n    million.webpack({ auto: true }),\n  ],\n};"},millionLint:{configFileContent:"const MillionLint = require('@million/lint').default;\nconst MillionLint = require('@million/lint').default;\nmodule.exports = {\n  plugins: [\n    MillionLint.webpack(),\n  ],\n};"},millionAndMillionLint:{configFileContent:"const million = require('million/compiler');\nconst MillionLint = require('@million/lint').default;\nmodule.exports = {\n  plugins: [\n    million.webpack({ auto: true }),\n    MillionLint.webpack(),\n  ],\n};"}},{name:"rollup",label:"Rollup",bundler:"rollup",prefix:"MillionLint.rollup",configFilePath:"rollup.config.js",possibleFileNames:["rollup.config.js","rollup.config.mjs","rollup.config.cjs","rollup.config.ts"],million:{configFileContent:"import million from 'million/compiler';\n\nexport default {\n  plugins: [million.rollup({ auto: true })],\n};"},millionLint:{configFileContent:"import MillionLint from '@million/lint';\n\nexport default {\n  plugins: [MillionLint.rollup()],\n};"},millionAndMillionLint:{configFileContent:"import million from 'million/compiler';\nimport MillionLint from '@million/lint';\n\nexport default {\n  plugins: [\n    million.rollup({ auto: true }),\n    MillionLint.rollup(),\n  ],\n};"}}];function re(e,n,i,t=1){const o=j.diffWords(e,n);let l="";o.forEach(((e,n)=>{const i=n>0&&(o[n-1]?.added||o[n-1]?.removed),r=n<o.length-1&&(o[n+1]?.added||o[n+1]?.removed);let a="";if(e.added)a=I($(e.value));else if(e.removed)a=z(e.value);else if(i&&r){const n=e.value.split("\n");a=n.length-1>2*t?[n.slice(0,t).join("\n"),"...",n.slice(-t-1).join("\n")].join("\n"):N(e.value)}else i?a=e.value.split("\n").slice(0,t+1).join("\n"):r&&(a=e.value.split("\n").slice(-t-1).join("\n"));l+=a})),v.note(l,`Take a look at changes in ${T(i)}`)}var ae=C.default.promisify(u.exec);async function se({packageManager:e,packageNames:n,flags:i=[],cwd:t}){"yarn"!==e.name&&"pnpm"!==e.name||i.push("--ignore-workspace-root-check");const{stderr:o}=await ae(`${e.installCommand} ${n.map((e=>`${e}@latest`)).join(" ")} ${i.join(" ")}`,{cwd:t});if(o){v.log.error(z(o)),"npm"===e.name&&i.push("--legacy-peer-deps");try{const{stderr:o}=await ae(`${e.installCommand} ${n.map((e=>`${e}@latest`)).join(" ")} ${i.join(" ")}`,{cwd:t});o&&v.log.error(z(o))}catch(e){Y({event:"wizard-failed-install-package",message:e.stdout||e.stderr||e.message,properties:{body:e},needAbort:!0})}}}var ce=null;async function ue(e){if(ce)return ce;const n=await async function(e){const n=await c.detect({cwd:e});if(!n)return null;const[i]=n.split("@");switch(i){case"yarn":return X;case"pnpm":return ee;case"npm":return ne;case"bun":return ie;default:return null}}(e),i=await K(v.select({message:"Please select your package manager.",options:te.map((e=>({value:e,label:e.label,hint:`Be sure you have ${$(e.label)} installed.`}))),initialValue:n||void 0}));return ce=i}async function pe({packageNames:e,alreadyInstalledPackageNames:n,askBeforeUpdating:i=!0,cwd:t,installVSCode:o=!0,packageManager:l}){const r=e.map((e=>T($(e)))).join(", "),a=n?.map((e=>T($(e)))).join(", ");if(a?.length&&i){if(!await K(v.confirm({message:`The ${a} package is already installed. Do you want to update it to the latest version?`})))return}l=l||await ue(t);const s=v.spinner();s.start(`${n?.length?"Updating":"Installing"} ${r} with ${$(l.label)}.`);try{await se({packageManager:l,packageNames:e,cwd:t}),Y({type:"info",event:"wizard-package-manager",properties:{body:JSON.stringify(l)}}),s.stop(`${n?.length?"Updated":"Installed"} ${r} with ${$(l.label)}.`)}catch(e){Y({event:"wizard-failed-install",message:e,properties:{body:e}});const n="npm"===l.name&&e.message.includes("npm ERR"),i="yarn"===l.name&&e.message.includes("error "),t="pnpm"===l.name&&e.message.includes("ERR_"),o="bun"===l.name&&e.message.includes("error: "),r=n||i||t||o?"Error":"Warnings";v.log.error(z(`${r} during installation. ${e}`)),s.stop();if(!await K(v.confirm({message:"Would you like to continue anyway?"})))return Y({event:"wizard-abort",properties:{body:e.message},needAbort:!0})}if(o){const e=v.spinner();try{e.start("Installing VSCode extension.");const i=await async function(){const{stdout:e}=await ae("code --install-extension million.million-lint --force");return e.includes("already installed")?"VSCode extension already installed.":e.includes("not found")?"Code CLI not found. Try installing the extension manually. Search for 'million lint' in the extensions marketplace.":null}();Y({type:"info",event:"wizard-vscode-install",properties:{body:JSON.stringify(i)}}),i?e.stop(i):e.stop((n?.length?"Updated":"Installed")+" VSCode extension.")}catch(n){Y({event:"wizard-vscode-failed-install",properties:{body:n}}),v.log.error(z("Could not install VSCode extension. Look up 'million-lint' in the extensions marketplace to install manually.")),e.stop();if(!await K(v.confirm({message:"Would you like to continue anyway?"})))return Y({event:"wizard-abort",message:"VSCode extension installation failed.",properties:{body:n.message},needAbort:!0})}}}function fe(e){return!!e&&!!e.includes("react-scripts start")}async function de(e,n,i){if(fe(e)){let t=e;t=t.replace("react-scripts start","craco start"),t=t.replace("react-scripts build","craco build"),t=t.replace("react-scripts test","craco test");const o=["@craco/craco",...n].map((e=>T($(e)))).join(", ");try{const e=await ue(i);await k.promises.writeFile(w.default.join(i,"package.json"),t),n.includes("million")&&n.includes("@million/lint")?await k.promises.writeFile(w.default.join(i,"craco.config.js"),oe.millionAndMillionLint.configFileContent):n.includes("million")?await k.promises.writeFile(w.default.join(i,"craco.config.js"),oe.million.configFileContent):n.includes("@million/lint")&&await k.promises.writeFile(w.default.join(i,"craco.config.js"),oe.millionLint.configFileContent);const l=v.spinner();l.start(`Installing ${o}...`),await se({packageManager:e,packageNames:["@craco/craco"],cwd:i,flags:["-D"]}),await se({packageManager:e,packageNames:n,cwd:i}),l.stop(`${o} installed.`)}catch(e){return Y({event:"wizard-error-install-craco",message:`Could not install ${o}. Please install it manually.`,properties:{body:e}})}}}var me=new Set(["<",">","{","}","[","]"]),ge=new Set(["for","do","while","if","else","return","function","var","let","const","true","false","undefined","this","new","delete","typeof","in","instanceof","void","break","continue","switch","case","default","throw","try","catch","finally","debugger","with","yield","async","await","class","extends","super","import","export","from","static"]),be=new Set(["+","-","*","/","%","=","!","&","|","^","~","!","?",":",".",",",";","'",'"',".","(",")","[","]","#","@","\\",...me]),[ye,we,he,ve,xe,ke,Ce,je,Le,Fe,Me]=["identifier","keyword","string","class","property","entity","jsxliterals","sign","comment","break","space"].map(((e,n)=>n));function Se(e){return/^[^\S\r\n]+$/g.test(e)}function Pe(e){return be.has(e)}function $e(e){return/^[\w_]+$/.test(e)||Ne(e)}function Ne(e){return/[^\u0000-\u007f]/.test(e)}function ze(e){return/^[a-zA-Z]$/.test(e)}function Ie(e){return ze(e)||Ne(e)}function Ee(e){return Ie(e[0])&&(1===e.length||$e(e.slice(1)))}function Ae(e){return"`"===e}function Oe(e){return'"'===e||"'"===e}function Te(e){return"//"===(e=e.slice(0,2))||"/*"===e}function Ve(e){let n="",i=-1,t=[-1,""],o=[-2,""];const l=[];let r=!1,a=0,s=!1,c=0;const u=()=>r&&!s&&!a,p=()=>a&&!u(),f=()=>!a&&u()&&!s&&c>0;let d=null,m=0,g=0;const b=()=>null!==d,y=()=>g>m,w=()=>b()||y();function h(e){const n="\n"===e;if(p()){if(b())return he;const[,n]=t;if(Ee(e)&&("<"===n||"</"===n))return ke}if(f())return Ce;if(b())return he;if(ge.has(e))return"."===t[1]?ye:we;if(n)return Fe;if(Se(e))return Me;if(e.split("").every(Pe))return je;if(function(e){const n=e[0];return $e(n)&&n===n.toUpperCase()||"null"===e}(e))return p()?ye:ve;if(Ee(e)){const e="."===t[1]&&Ee(o[1]);if(!w()&&!e)return ye;if(e)return xe}return he}const v=(e,r)=>{if(r&&(n=r),n){i=e||h(n);const r=[i,n];i!==Me&&i!==Fe&&(o=t,t=r),l.push(r)}n=""};for(let i=0;i<e.length;i++){const o=e[i],l=e[i-1],p=e[i+1],b=l+o,h=o+p;if(Oe(o)&&!f()){v(),"\\"!==l&&(d&&o===d?d=null:d||(d=o)),v(he,o);continue}if(!y()&&"\\n"!==l&&Ae(o)){v(),v(he,o),g++;continue}if(y()){if("\\n"!==l&&Ae(o)&&g>0){v(),g--,v(he,o);continue}if("${"===h){m++,v(he),v(je,h),i++;continue}}if(g>0&&g===m&&"}"===o){v(),m--,v(je,o);continue}if(u()&&"{"===o){v(),v(je,o),s=!0;continue}if(r){if(!a&&"<"===o){v(),"/"===p?(a=2,n=h,i++):(a=1,n=o),v(je);continue}if(a){if(">"===o&&!"/=".includes(l)){v(),1===a?(a=0,c++):(a=0,r=!1),v(je,o);continue}if("/>"===h||"</"===h){"<"!==n&&"/"!==n&&v(),"/>"===h?a=0:c--,c||(r=!1),n=h,i++,v(je);continue}if("<"===o){v(),n=o,v(je);continue}if("-"===p&&!w()&&!f()&&n){v(xe,n+o+p),i+=1;continue}if("="===p&&!w()){const e=n?n+o:o;Ee(e)&&(n=e,v(xe));continue}}}!a&&("<"===o&&Ie(p)||"</"===h)&&(a="/"===p?2:1,"<"!==o||"/"!==p&&!ze(p)||(r=!0));const C=Oe(k=o)||Ae(k),j=y(),L=!r&&("/"===(x=h)[0]&&!Te(x[0]+x[1])),F=f();if(C||j||Oe(d))n+=o;else if(L){v();const[l,r]=t;if(L&&-1!==l&&(l!==je||")"===r)&&l!==Le){n=o,v();continue}const a=i++,s=()=>i>=e.length,c=()=>s()||"\n"===e[i];let u=!1;for(;!c();i++)if("/"===e[i]&&"\\"!==e[i-1]){for(u=!0;a!==i&&/^[a-z]$/.test(e[i+1])&&!c();)i++;break}a!==i&&u?(n=e.slice(a,i+1),v(he)):(n=o,v(),i=a)}else if(Te(h)){v();const t=i;if("/"===p)for(;i<e.length&&"\n"!==e[i];i++);else for(;i<e.length&&e[i-1]+e[i]!=="*/";i++);n=e.slice(t,i+1),v(Le)}else" "===o||"\n"===o?" "!==o||!Se(n)&&n&&!F?(v(),n=o,v()):(n+=o,"<"===p&&v()):s&&"}"===o?(v(),n=o,v(),s=!1):F&&!me.has(o)||($e(o)===$e(n[n.length-1])||u())&&!be.has(o)?n+=o:("</"===b&&(n=b),v(),"</"!==b&&(n=o),"</"===h||"/>"===h?(n=h,v(),i++):me.has(o)&&v())}var x,k;return v(),l}function qe(e,n={showLineNumbers:!1}){const i=Ve(e),t=[];let o=1;const l=[];function r(e){t.push(function(e){const i=n.showLineNumbers?`${N(`${o}`.padEnd(2," "))} `:"";return o++,`${i}${e}`}(e.map((([e,n])=>{switch(e){case 0:case 4:return O(n);case 1:case 2:case 7:return q(n);case 3:return E(n);case 5:return A(n);case 6:return V(n);case 8:return N(n);default:return n}})).join("")))}for(const e of i){const[n,i]=e;if(9!==n)if(i.includes("\n")){const e=i.split("\n");for(let i=0;i<e.length;i++)l.push([n,e[i]]),i<e.length-1&&(r(l),l.length=0)}else l.push(e);else l.push([n,""]),r(l),l.length=0}return l.length>0&&r(l),t.join("\n")}async function Re(e,n,i){let t;v.note(`found existing ${e.configFilePath} file.`,`Transforming ${T(e.configFilePath)}`);try{let o=await async function(e,n){const i=w.default.join(n,e.configFilePath);return await x.default.readFile(i,{encoding:"utf-8"})}(e,i);const l=o,r=w.default.join(i,e.configFilePath);let a=!1;for(const e of n)"@million/lint"===e?o.includes("@million/lint")&&(a=!0):"million"===e&&(o.includes("million/compiler")||o.includes("million"))&&(a=!0);a&&Y({event:"wizard-already-configured",message:z(`@million/lint is already configured in ${e.configFilePath}.`),needAbort:!0});const s=v.spinner(),c=function(e){if(e.includes("module.exports =")||e.includes("exports."))return"cjs";if(e.includes("export default"))return"esm";return"unknown"}(o);if(Y({event:"wizard-modify-config",properties:{body:{type:c,oldCode:l,filePath:r}}}),"unknown"===c)return Y({event:"wizard-unknown-module-type",message:"Unknown module type. Aborting.",needAbort:!0});let u,p,f;n.forEach((e=>{"million"===e?o=("esm"===c?"import million from 'million/compiler';\n":"const million = require('million/compiler');\n")+o:"@million/lint"===e&&(o=("esm"===c?"import MillionLint from '@million/lint';\n":"const MillionLint = require('@million/lint');\n")+o)})),"next"===e.name&&(u=await async function(){return k.existsSync("pages")?"pages":k.existsSync("app")?"app":k.existsSync("src/pages")?"pages":k.existsSync("src/app")?"app":await K(v.select({message:"Will you use app Router or pages Router?",options:[{label:"App Router",value:"app"},{label:"Pages Router",value:"pages"}]}))}()),s.start(`Modifying config file ${T(e.configFilePath)}...`),n.includes("million")&&n.includes("@million/lint")?(p=e.millionAndMillionLint.configFileContent,f=e.millionAndMillionLint.configFileContentRSC):n.includes("million")?(p=e.million.configFileContent,f=e.million.configFileContentRSC):n.includes("@million/lint")&&(p=e.millionLint.configFileContent,f=e.millionLint.configFileContentRSC),t="app"===u?f:p;const m=await async function(e,n,i,t,o){const{name:l,bundler:r}=n;try{const n=(e,n,t)=>{const a=n(e),s=e=>L.callExpression(L.memberExpression(L.identifier("million"),L.identifier(r)),"astro"===l||"gatsby"===l?[L.objectExpression([L.objectProperty(L.identifier("mode"),L.stringLiteral("react")),L.objectProperty(L.identifier("server"),L.booleanLiteral(!0)),L.objectProperty(L.identifier("auto"),L.booleanLiteral(!0))])]:"next"===l?[e,L.objectExpression([L.objectProperty(L.identifier("auto"),L.booleanLiteral(!0))])]:[L.objectExpression([L.objectProperty(L.identifier("auto"),L.booleanLiteral(!0))])]),c=()=>L.callExpression(L.memberExpression(L.identifier("MillionLint"),L.identifier(r)),"craco"===l?[L.objectExpression([L.objectProperty(L.identifier("legacyHmr"),L.booleanLiteral(!0))])]:o?[L.objectExpression([L.objectProperty(L.identifier("rsc"),L.booleanLiteral(!0))])]:[]),u=()=>{const e=[];return i.includes("million")&&e.push(s()),i.includes("@million/lint")&&e.push(c()),e};if("next"===l){if(L.isClassDeclaration(a)||L.isFunctionDeclaration(a)||L.isTSDeclareFunction(a))return;i.includes("million")&&i.includes("@million/lint")?t(s(L.callExpression(c(),[a]))):i.includes("million")?t(s(a)):i.includes("@million/lint")&&t(L.callExpression(c(),[a]))}if("vite"===l||"webpack"===l||"rollup"===l||"esbuild"===l||"rspack"===l||"craco"===l||"gatsby"===l||"astro"===l){let n=!1;if(e.traverse({ObjectProperty(i){if("craco"===l){if(L.isIdentifier(i.node.key)&&"plugins"===i.node.key.name&&L.isProperty(i.node)&&!L.isPattern(i.node.value)&&!L.isRestElement(i.node.value)&&!L.isIdentifier(i.node.value)){let t;n=!0,t=L.isObjectExpression(i.node.value)&&i.node.value.properties.some((e=>L.isObjectProperty(e)&&L.isIdentifier(e.key)&&"add"===e.key.name))?i.node.value.properties.find((e=>L.isObjectProperty(e)&&L.isIdentifier(e.key)&&"add"===e.key.name)):L.objectProperty(L.identifier("add"),L.arrayExpression(u())),e.insertBefore([L.variableDeclaration("const",[L.variableDeclarator(L.identifier("_plugins"),t.value)]),L.callExpression(L.memberExpression(L.identifier("_plugins"),L.identifier("unshift")),u())]),L.isObjectExpression(i.node.value)&&(i.node.value.properties=i.node.value.properties.filter((e=>!(L.isObjectProperty(e)&&L.isIdentifier(e.key)&&"add"===e.key.name))),i.node.value.properties.push(L.objectProperty(L.identifier("add"),L.identifier("_plugins"))))}}else!L.isIdentifier(i.node.key)||"plugins"!==i.node.key.name||!L.isProperty(i.node)||L.isPattern(i.node.value)||L.isRestElement(i.node.value)||L.isIdentifier(i.node.value)||(n=!0,e.insertBefore([L.variableDeclaration("const",[L.variableDeclarator(L.identifier("_plugins"),i.node.value)]),L.callExpression(L.memberExpression(L.identifier("_plugins"),L.identifier("unshift")),u())]),i.node.value=L.identifier("_plugins"))}}),!n){let n;const i=L.variableDeclaration("const",[L.variableDeclarator(L.identifier("_plugins"),L.arrayExpression(u()))]),t=L.objectProperty(L.identifier("plugins"),L.identifier("_plugins"));if(e.insertBefore([i]),"astro"===l){let e;a&&"CallExpression"===a.type&&L.isIdentifier(a.callee)&&"defineConfig"===a.callee.name&&(n=a.arguments[0]),n?.properties.length?e=n.properties.find((e=>!("ObjectProperty"!==e.type||!L.isIdentifier(e.key)||"vite"!==e.key.name||"ObjectExpression"!==e.value.type)))||L.objectProperty(L.identifier("vite"),L.objectExpression([t])):(e=L.objectProperty(L.identifier("vite"),L.objectExpression([t])),n=L.objectExpression([e])),a&&"CallExpression"===a.type&&L.isIdentifier(a.callee)&&"defineConfig"===a.callee.name&&(a.arguments[0]=n)}else"gatsby"===l?e.traverse({CallExpression(e){L.isMemberExpression(e.node.callee)&&L.isIdentifier(e.node.callee.property)&&"setWebpackConfig"===e.node.callee.property.name&&(n=e.node.arguments[0]),n?.properties.length?n.properties.push(t):n=L.objectExpression([t]),L.isMemberExpression(e.node.callee)&&L.isIdentifier(e.node.callee.property)&&"setWebpackConfig"===e.node.callee.property.name&&(e.node.arguments[0]=n)}}):"craco"===l?L.isObjectExpression(a)&&a.properties.push(L.objectProperty(L.identifier("webpack"),L.objectExpression([L.objectProperty(L.identifier("add"),L.identifier("_plugins"))]))):L.isObjectExpression(a)&&a.properties.push(t)}}},t=()=>({name:"wizard",visitor:{MemberExpression(e){const i=L.isIdentifier(e.node.object)&&"module"===e.node.object.name&&L.isIdentifier(e.node.property)&&"exports"===e.node.property.name,t=L.isIdentifier(e.node.object)&&"exports"===e.node.object.name;if(i||t){if(!L.isAssignmentExpression(e.parent))return;n(e.parentPath,(e=>e.node.right),(n=>{e.node.right=n}))}},ExportDefaultDeclaration(e){n(e,(e=>e.node.declaration),(n=>{e.node.declaration=n}))}}}),a=await d.transformAsync(e,{plugins:[t()],parserOpts:{plugins:["jsx","typescript"]}});return a?(Y({type:"info",event:"wizard-success-modify-config",properties:{body:JSON.stringify(a)}}),a.code):null}catch(e){return Y({event:"wizard-failed-get-new-file-content",message:`Unable to modify config file.\n\nHere is an installation reference:\n\n${qe(t,{showLineNumbers:!0})}`,properties:{body:e},needAbort:!0}),null}}(o,e,n,t,"app"===u);if(!m)return Y({event:"wizard-no-changes-made",message:`Reverted the changes.\n\nHere is an installation reference:\n\n${qe(t,{showLineNumbers:!0})}`,needAbort:!0});await x.default.writeFile(r,m,{encoding:"utf-8",flag:"w"}),s.stop(`Modified config file ${T(e.configFilePath)}.`),re(l,m,e.configFilePath);const g=async()=>{await x.default.writeFile(r,l,{encoding:"utf-8",flag:"w"}),Y({event:"wizard-reverted-changes",message:`Reverted the changes.\n\nHere is an installation reference:\n\n${qe(t,{showLineNumbers:!0})}`,needAbort:!0})};await K(v.confirm({message:"Does the config file look good?",initialValue:!0}),g)||await g()}catch(e){return v.log.error(e),Y({event:"wizard-failed-modify-config",message:`Failed to modify config file.\n\nHere is an installation reference:\n\n${qe(t,{showLineNumbers:!0})}`,needAbort:!0})}}async function _e(){const e=w.default.join(h.default.cwd());await v.group({packageDotJson:async()=>await Q(e),selectPackages:async({results:e})=>{if(!e.packageDotJson)return;return await v.multiselect({message:"Please select the packages you want to install",options:[{value:"@million/lint",label:"Million Lint"},{value:"million",label:"Million.js"}],initialValues:["million","@million/lint"],required:!0})},buildTool:async({results:n})=>{if(!n.packageDotJson||!n.selectPackages?.length)return;const i=await async function({packageJsonContents:e,packages:n,cwd:i}){const t=[];for(const o of le){if("craco"===o.name&&fe(e))return await K(await v.confirm({message:"Ordinary create-react-app projects are not supported. Do you want to use craco instead of react-scripts?"}))?void await de(e,n,i):void Y({event:"wizard-craco-not-installed",message:"Please install craco manually: https://craco.js.org/docs/getting-started",needAbort:!0});for(const e of o.possibleFileNames)if(k.existsSync(w.default.join(i,e))){const n={...o,configFilePath:e};t.push({buildTool:n})}else if(k.existsSync(w.default.join(i,"config",e))){const n={...o,configFilePath:w.default.join("config",e)};t.push({buildTool:n})}if("gatsby"===o.name)for(const e of o.otherPossibleFileNames)if(k.existsSync(w.default.join(i,e))){const e=o;n.includes("million")&&n.includes("@million/lint")?await k.promises.writeFile(w.default.join(i,o.configFilePath),o.millionAndMillionLint.configFileContent):n.includes("million")?await k.promises.writeFile(w.default.join(i,o.configFilePath),o.million.configFileContent):n.includes("@million/lint")&&await k.promises.writeFile(w.default.join(i,o.configFilePath),o.millionLint.configFileContent),t.push({buildTool:e,skipUpdateConfigFile:!0})}}if(t.length){if(1===t.length)return v.log.success(`Detected ${T($(t[0].buildTool.label))} project.`),t[0];const e=await K(await v.select({message:"Detected multiple build tools. Please select one:",options:t.map((e=>({label:e.buildTool.label,value:e.buildTool.name,hint:e.buildTool.configFilePath}))),initialValue:t[0].buildTool.name}));return t.find((n=>n.buildTool.name===e))}Y({event:"wizard-no-build-tool-detected",message:`No build tool detected. No configuration file found in the current path: ${i}`,needAbort:!0})}({packageJsonContents:n.packageDotJson.packageJsonContents,packages:n.selectPackages,cwd:e}),{buildTool:t,skipUpdateConfigFile:o}=i||{};return{buildTool:t,skipUpdateConfigFile:o}},install:async({results:n})=>{if(!n.packageDotJson||!n.buildTool?.buildTool||!n.selectPackages?.length)return;const i=await async function(e,n=["@million/lint"]){const i=[],t=await Q(e),o=t?.packageJson;for(const e of n)o?.dependencies?.[e]&&i.push(e);return i}(e,n.selectPackages);await pe({packageNames:n.selectPackages,alreadyInstalledPackageNames:i,cwd:e,installVSCode:n.selectPackages.includes("@million/lint")})},updateConfigFile:async({results:n})=>{n.buildTool?.buildTool&&(n.buildTool?.skipUpdateConfigFile||n.selectPackages?.length&&await Re(n.buildTool.buildTool,n.selectPackages,e))},other:async({results:n})=>{n.buildTool?.buildTool&&(n.buildTool?.skipUpdateConfigFile||n.selectPackages?.length&&await async function(e){if(!e)return;const n="# Million Lint\n.million\n",i=w.default.join(e,".gitignore");if(k.default.existsSync(i)){const e=await x.default.readFile(i,"utf-8");if(e.includes(".million"))return;const t=`${e}\n${n}`;await x.default.writeFile(i,t),re(e,t,i)}else{const e=n;await x.default.writeFile(i,e),re("",e,i)}}(e))}},{onCancel:({results:e})=>{Y({event:"wizard-cancel",properties:{body:e}}),v.cancel("Million Lint setup cancelled."),Z().then((()=>h.default.exit(1)))}}),Y({type:"info",event:"wizard-complete",properties:{body:!0}}),Z().then((()=>h.default.exit(1)))}exports.beta=async function(e){try{v.intro(A(`⚡ ${$("Million Lint beta")}`)),await async function(e){const n=w.default.join(process.cwd());await v.group({getVersions:async()=>{const n=v.spinner();try{let{npmVersion:i,vscodeVersion:t}=e.reduce(((e,n)=>{try{const[i,t]=n.split("=");return{...e,[i.split("--")[1]]:t}}catch{return e}}),{npmVersion:"",vscodeVersion:""});if(!i||!t){n.start("Fetching latest versions");let e="version.txt";i?e=`version-npm-${i}.txt`:t&&(e=`version-vscode-${t}.txt`);const o=await fetch(`https://beta-lint-r2.million.dev/${e}`).then((e=>e.text())).then((e=>{const[n,o]=e.split("\n");return{npm:i||n,vscode:t||o}}));i=o.npm,t=o.vscode,n.stop()}return v.note(`Downloading packages for NPM ${i} and VSCode ${t}`,"Get ready to install the packages."),{npmVersion:i,vscodeVersion:t}}catch(e){return n.stop(),Y({event:"beta-error",message:"Failed to fetch versions",properties:{body:e}})}},fetchPackages:async({results:e})=>{if(!e.getVersions)return;const i=v.spinner();try{const{npmVersion:t,vscodeVersion:o}=e.getVersions;i.start("Downloading packages");const l=await fetch(`https://beta-lint-r2.million.dev/million-lint-${t}.tgz`).then((e=>e.arrayBuffer())).then((e=>Buffer.from(e))),r=w.default.join(n,`million-lint-${t}.tgz`);await x.default.writeFile(r,l);const a=await fetch(`https://beta-lint-r2.million.dev/million-lint-${o}.vsix`).then((e=>e.arrayBuffer())).then((e=>Buffer.from(e))),s=w.default.join(n,`million-lint-${o}.vsix`);await x.default.writeFile(s,a),i.message(`Downloaded packages: NPM ${t}, VSCode ${o}`);const u=await c.detect({programmatic:!0,cwd:n});if(!u)return Y({event:"beta-error",message:"No package manager found",properties:{body:"No package manager found"}});const p=await c.parseNi(u,[r]);if(!p)return Y({event:"beta-error",message:"Failed to create install command",properties:{body:"Failed to create install command"}});const{stderr:f}=await ae(p);if(f)return Y({event:"beta-error",message:"Failed to install packages",properties:{body:f}});const d=`code --install-extension ${s}`,{stderr:m}=await ae(d);if(m)return Y({event:"beta-error",message:"Failed to install packages",properties:{body:m}});await x.default.unlink(r),await x.default.unlink(s),i.stop()}catch(e){return i.stop(),Y({event:"beta-error",message:"Failed to fetch packages",properties:{body:e}})}}},{onCancel:({results:e})=>{Y({event:"beta-cancel",properties:{body:e}}),v.cancel("Million beta cancelled."),Z().then((()=>process.exit(1)))}})}(e),v.outro(`${I($("✓ "))} You're all set! Enjoy! 🎉`)}catch(e){Y({event:"beta-error",message:e,properties:{body:e}})}},exports.install=async function(e,n=h.default.env.VERSION){try{h.default.env.MILLION_INSTALL_NAME=e||"",h.default.env.MILLION_INSTALL_VERSION=n||"",h.default.env.MILLION_INSTALL_ROOT=w.default.join(h.default.cwd()),i.intro(A(`⚡ ${$(e)} ${N(n||"")}`)),await _e(),i.outro(`${I($("✓ "))} You're all set!`)}catch(e){Y({event:"wizard-error",message:e,properties:{body:e}})}};